<attachment contenteditable="false" data-atts="%5B%5D" data-aid=".atts-848d6844-d283-46d7-841b-15c67aaf6381"></attachment><p>参考文档：</p><p><br></p><h1>Java层和Native层是同一个Looper</h1><p>线程的looper保存在TLS(ThreadLocal Storage)中，通过Looper.myLopper() (Java层) 或 Looper.getForThread() (Native层) 获取当前线程的Looper实例</p><p><br></p><h1>Java层和Native层各有一个MessageQueue</h1><p>Java层MessageQueue调用nativeInit()初始化NativeMessageQueue;</p><p>Java层MessageQueue通过next() 与Native层同步；</p><p>每次Polling Native层MessageQueue中需要处理的消息全部处理完才会处理Java层的消息，也就是Native层的消息优先级高于Java层消息</p><h1>通过epoll_wait()监听消息</h1><p>NativeMessageQueue.pollOnce()中通过epoll_wait()监听消息；</p><p>Native层没法直接往NativeMessageQueue post消息，需要通过epoll_ctrl()增加一个fd、并自己维护一个MessageQueue, 然后通过该fd的回调来处理自己MessageQueue中的消息</p><p><br></p>